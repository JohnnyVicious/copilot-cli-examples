name: PowerShell Tests

on:
  workflow_dispatch:
  push:
    paths:
      - "tests/powershell/**"
      - "results/powershell/**"
      - ".github/workflows/powershell-tests.yml"
  pull_request:
    paths:
      - "tests/powershell/**"
      - "results/powershell/**"
      - ".github/workflows/powershell-tests.yml"

jobs:
  test:
    runs-on: ubuntu-24.04
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: Run Pester tests
        shell: pwsh
        run: |
          if (Test-Path "tests/powershell") {
            $testFiles = Get-ChildItem -Path "tests/powershell" -Filter "*.Tests.ps1" -Recurse
            if ($testFiles.Count -gt 0) {
              if (-not (Get-Module -ListAvailable -Name Pester)) {
                Install-Module Pester -Scope CurrentUser -Force -SkipPublisherCheck
              }
              Invoke-Pester -Path "tests/powershell" -CI
            }
            else {
              Write-Host "No PowerShell test files (*.Tests.ps1) found in tests/powershell"
            }
          }
          else {
            Write-Host "No PowerShell tests found in tests/powershell"
          }
